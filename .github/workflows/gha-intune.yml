name: GitHub Actions
on: workflow_dispatch
jobs: 
  test:
    permissions:
      id-token: write # Require write permission to Fetch an OIDC token.

    runs-on: ubuntu-latest
    steps:
    - name: Azure Login
      uses: azure/login@v2.3.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        allow-no-subscriptions: true
        enable-AzPSSession: true
    
    - name: Azure CLI script
      uses: azure/cli@v2
      with:
        azcliversion: latest
        inlineScript: |
          az ad user list
    
    - name: Get Graph API Token & List Users
      shell: pwsh
      run: |
        $GraphTokenResponse = az account get-access-token --resource https://graph.microsoft.com
        $GraphToken = ($GraphTokenResponse | ConvertFrom-Json).accessToken
        $headers = @{
        "Content-Type" = "application/json"
        Authorization = "Bearer {0}" -f $GraphToken}
        $apiUrl = "https://graph.microsoft.com/v1.0/users"
        $method = "GET"
        Invoke-webrequest -Uri $apiUrl -Method $method -Headers $headers
